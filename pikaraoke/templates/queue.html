{% extends 'base.html' %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
  // Pass admin status from server to JavaScript
  var isAdmin = JSON.parse('{{ admin | tojson }}');

  // Escape strings for safe use in HTML attributes
  function escape(str) {
    return encodeURIComponent(str);
  }

  // Ensure global socket exists
  if (typeof window.socket === 'undefined') {
    window.socket = io();
  }

  // Initialize queue state if needed
  if (typeof window.queuePageState === 'undefined') {
    window.queuePageState = {
      queue: [],
      previousQueue: null,
      nowPlaying: null,
      previousNowPlaying: null
    };
  }

  // Define global queue functions
  window.queuePage_getQueue = function() {
    if ($('#auto-refresh').length === 0) {
      return;
    }

    // Fetch both queue and now_playing data
    $.when(
      $.get('{{ url_for("queue.get_queue") }}'),
      $.get('{{ url_for("now_playing.now_playing") }}')
    ).done(function(queueResp, nowPlayingResp) {
      var newQueue = JSON.parse(queueResp[0]);
      var newNowPlaying = nowPlayingResp[0] ? JSON.parse(nowPlayingResp[0]) : null;

      var queueChanged = !isEqual(newQueue, window.queuePageState.previousQueue);
      var npChanged = !isEqual(newNowPlaying, window.queuePageState.previousNowPlaying);

      if (queueChanged || npChanged) {
        window.queuePageState.queue = newQueue;
        window.queuePageState.nowPlaying = newNowPlaying;
        $("#auto-refresh").html(window.queuePage_generateHTML());
        window.queuePageState.previousQueue = newQueue;
        window.queuePageState.previousNowPlaying = newNowPlaying;

        // Initialize Drag and Drop after HTML is rendered
        window.initSortable();
      }
    });
  };

  window.initSortable = function() {
    var el = document.getElementById('auto-refresh');
    // Only init if admin (drag handles exist) and not already initialized
    if ($(".drag-handle").length > 0 && el && !el.sortable) {
       Sortable.create(el, {
          handle: '.drag-handle', // Only drag using the handle icon
          animation: 150,
          filter: '.disabled-sort', // Cannot drag now-playing row
          onMove: function (evt) {
             // Prevent moving an item to the now-playing position
             return evt.related.className.indexOf('disabled-sort') === -1;
          },
          onEnd: function (evt) {
             if (evt.oldIndex === evt.newIndex) return;

             // Calculate offset: if now-playing row exists, DOM indices are offset by 1
             var np = window.queuePageState.nowPlaying;
             var offset = (np && np.now_playing) ? 1 : 0;

             // Convert DOM indices to queue array indices
             var oldQueueIndex = evt.oldIndex - offset;
             var newQueueIndex = evt.newIndex - offset;

             // Send queue indices to backend
             $.post("{{ url_for('queue.reorder') }}", {
                 old_index: oldQueueIndex,
                 new_index: newQueueIndex
             }).done(function() {
                 // Force refresh to update data attributes
                 window.queuePageState.previousQueue = null;
                 window.queuePage_getQueue();
             });
          }
      });
      el.sortable = true;
    }
  };

  window.queuePage_generateHTML = function() {
    var html = "";
    var queue = window.queuePageState.queue;
    var np = window.queuePageState.nowPlaying;
    var colSpan = isAdmin ? 4 : 2;
    var rowNum = 1;

    // Now Playing row (if something is playing)
    if (np && np.now_playing) {
      html += '<tr class="disabled-sort has-background-dark">';
      html += '<td width="20px" style="padding: 8px 5px; vertical-align: middle;">' + rowNum + '</td>';

      if (isAdmin) {
        // Playback controls for currently playing song
        html += '<td width="100px" class="has-text-centered" style="padding: 5px 0px; vertical-align: middle;">';
        html += '<div class="buttons are-small has-addons is-centered" style="margin-bottom: 0;">';
        html += '<button class="button is-small playback-btn" data-action="restart" title="{{ _("Restart") }}">';
        html += '<i class="icon icon-to-start"></i></button>';
        if (np.is_paused) {
          html += '<button class="button is-small playback-btn" data-action="pause" title="{{ _("Play") }}">';
          html += '<i class="icon icon-play"></i></button>';
        } else {
          html += '<button class="button is-small playback-btn" data-action="pause" title="{{ _("Pause") }}">';
          html += '<i class="icon icon-pause"></i></button>';
        }
        html += '<button class="button is-small playback-btn" data-action="skip" title="{{ _("Skip") }}">';
        html += '<i class="icon icon-to-end"></i></button>';
        html += '</div></td>';
      }

      // Username and song title
      html += '<td style="padding: 8px 10px; vertical-align: middle;">';
      html += '<div class="is-flex is-flex-wrap-wrap is-align-items-baseline">';
      html += '<span class="has-text-success">' + np.now_playing_user + '</span>';
      html += '<span class="is-hidden-mobile has-text-grey mx-2">&bull;</span>';
      html += '<span class="has-text-weight-bold has-text-success is-hidden-mobile">' + np.now_playing + '</span>';
      html += '<span class="is-size-7 has-text-weight-bold has-text-success is-hidden-tablet" style="width: 100%;">' + np.now_playing + '</span>';
      html += '</div></td>';

      if (isAdmin) {
        html += '<td width="50px"></td>';
      }
      html += '</tr>';
      rowNum++;
    }

    // Queue rows
    if (queue.length > 0) {
      queue.forEach(function(e, index) {
        html += '<tr data-index="' + index + '">';
        html += '<td width="20px" style="padding: 8px 5px; vertical-align: middle;">' + rowNum + '</td>';

        if (isAdmin) {
          // Drag handle for queued songs
          html += '<td width="100px" class="has-text-centered" style="padding: 5px 0px; vertical-align: middle;">';
          html += '<div class="drag-handle" style="cursor: grab; padding: 7px;" title="{{ _("Drag to reorder") }}">';
          html += '<i class="icon icon-th-list has-text-grey-light"></i></div>';
          html += '</td>';
        }

        // Username and song title - responsive layout
        html += '<td style="padding: 8px 10px; vertical-align: middle;">';
        html += '<div class="is-flex is-flex-wrap-wrap is-align-items-baseline">';
        html += '<span class="has-text-success">' + e.user + '</span>';
        html += '<span class="is-hidden-mobile has-text-grey mx-2">&bull;</span>';
        html += '<span class="has-text-weight-bold is-hidden-mobile">' + e.title + '</span>';
        html += '<span class="is-size-7 has-text-weight-bold is-hidden-tablet" style="width: 100%;">' + e.title + '</span>';
        html += '</div></td>';

        if (isAdmin) {
          html += '<td width="50px" style="vertical-align: middle; text-align: right; padding-right: 10px;">';
          html += '<a class="button is-small is-text" data-index="' + index + '" data-file="' + escape(e.file) + '" data-title="' + escape(e.title) + '" title="{{ _("Options") }}">';
          html += '<i class="icon icon-cog is-size-5"></i></a>';
          html += '</td>';
        }

        html += '</tr>';
        rowNum++;
      });
    } else if (!np || !np.now_playing) {
      // Only show empty message if nothing is playing AND queue is empty
      html += '<tr><td colspan="' + colSpan + '"><p class="has-text-warning">{{ _("The queue is empty") }}</p></td></tr>';
    }

    return html;
  };

  // Open the modal menu
  window.openSongOptions = function(index, file, title) {
      $('#modal-song-title').text(title);

      // Update links with specific file
      var baseUrl = "/queue/edit?song=" + encodeURIComponent(file);
      $('#opt-up').attr('href', baseUrl + "&action=up");
      $('#opt-down').attr('href', baseUrl + "&action=down");
      $('#opt-top').attr('href', baseUrl + "&action=top");
      $('#opt-bottom').attr('href', baseUrl + "&action=bottom");
      $('#opt-delete').attr('href', baseUrl + "&action=delete");

      // Hide "Up"/"Play Next" if first in queue (index 0), hide "Down"/"Bottom" if last
      var queueLen = window.queuePageState.queue.length;
      (index === 0) ? $('#opt-up, #opt-top').hide() : $('#opt-up, #opt-top').show();
      (index >= queueLen - 1) ? $('#opt-down, #opt-bottom').hide() : $('#opt-down, #opt-bottom').show();

      $('#song-options-modal').addClass('is-active');
  }

  window.closeSongOptions = function() {
      $('#song-options-modal').removeClass('is-active');
  }

  // Socket listeners setup (same as before)
  // Socket listeners - refresh on queue or now_playing changes
  window.socket.off("queue_update");
  window.socket.on("queue_update", window.queuePage_getQueue);
  window.socket.off("now_playing");
  window.socket.on("now_playing", window.queuePage_getQueue);
  window.queuePageState.previousQueue = null;
  window.queuePageState.previousNowPlaying = null;

  // Initialize
  $(function() {
      window.queuePage_getQueue();
      // Close modal on background click
      $('.modal-background').click(window.closeSongOptions);

      // Use event delegation for menu buttons (handles dynamically generated content)
      $(document).on('click', '#auto-refresh a.button', function(e) {
          e.preventDefault();
          var $btn = $(this);
          var index = parseInt($btn.data('index'), 10);
          var file = decodeURIComponent($btn.data('file'));
          var title = decodeURIComponent($btn.data('title'));
          openSongOptions(index, file, title);
      });

      // Playback controls handler
      $(document).on('click', '.playback-btn', function(e) {
          e.preventDefault();
          var action = $(this).data('action');
          $.get('/' + action);
      });
  });

  // Visibility handler (same as before)
  // ... (Keep existing visibility logic here if needed) ...
</script>

{% endblock %}

{% block header %}
<h1 class>{% block title %}{% trans %}Queue{% endtrans %}{% endblock %}</h1>
{% endblock %}

{% block content %}

<table class="table is-striped" id="auto-refresh" style="margin-bottom: 30px">
</table>

{% if admin %}
<div class="is-flex is-justify-content-space-between is-align-items-center mb-3">
	<div class="is-flex is-align-items-center">
		<a class="add-random has-text-success" href="#"
			><i class="icon icon-plus-circled is-size-5 mr-1"></i></a>
			{% trans %}Add <input id="randomNumberInput" class="input mx-2 p-2" pattern="\d*" maxlength="2" value="3" min="1" max="99" style="width: 42px" /> random songs{% endtrans %}
	</div>
	<div>
		<a class="button is-danger is-outlined confirm-clear" href="/queue/edit?action=clear">
		<i class="icon icon-trash-empty mr-1"></i>{% trans %}Clear all{% endtrans %}</a>
	</div>
</div>

<div class="modal" id="song-options-modal">
  <div class="modal-background"></div>
  <div class="modal-card" style="width: 90%; max-width: 400px;">
    <header class="modal-card-head" style="padding: 15px;">
      <p class="modal-card-title is-size-6" id="modal-song-title">Song Options</p>
      <button class="delete" aria-label="close" onclick="closeSongOptions()"></button>
    </header>
    <section class="modal-card-body" style="padding: 0;">
        <a id="opt-top" class="panel-block py-3">
            <span class="icon has-text-info mr-2"><i class="icon-up-big"></i></span>
            <b>{% trans %}Play Next{% endtrans %}</b>&nbsp;({% trans %}Move to Top{% endtrans %})
        </a>
        <a id="opt-up" class="panel-block py-3">
            <span class="icon mr-2"><i class="icon-up-circled"></i></span>
            {% trans %}Move Up{% endtrans %}
        </a>
        <a id="opt-down" class="panel-block py-3">
            <span class="icon mr-2"><i class="icon-down-circled"></i></span>
            {% trans %}Move Down{% endtrans %}
        </a>
        <a id="opt-bottom" class="panel-block py-3">
            <span class="icon has-text-info mr-2"><i class="icon-down-big"></i></span>
            {% trans %}Move to Bottom{% endtrans %}
        </a>
        <a id="opt-delete" class="panel-block py-3 has-text-danger">
            <span class="icon mr-2"><i class="icon-trash-empty"></i></span>
            {% trans %}Remove from Queue{% endtrans %}
        </a>
    </section>
  </div>
</div>
{% endif %}

<div id="downloads-section" style="display:none; margin-top: 30px; border-top: 1px solid #dbdbdb; padding-top: 20px;">
    <h3 class="title is-4">{{ _('Download queue') }}</h3>
    <div id="downloads-container"></div>
</div>

{% endblock %}