{% extends 'base.html' %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
  // Pass admin status from server to JavaScript
  var isAdmin = JSON.parse('{{ admin | tojson }}');

  // Escape strings for safe use in HTML attributes
  function escape(str) {
    return encodeURIComponent(str);
  }

  // Ensure global socket exists
  if (typeof window.socket === 'undefined') {
    window.socket = io();
  }

  // Initialize queue state if needed
  if (typeof window.queuePageState === 'undefined') {
    window.queuePageState = {
      queue: [],
      previousQueue: null
    };
  }

  // Define global queue functions
  window.queuePage_getQueue = function() {
    if ($('#auto-refresh').length === 0) {
      return;
    }

    $.get('{{ url_for("queue.get_queue") }}', function (data) {
      var newQueue = JSON.parse(data);
      if (!isEqual(newQueue, window.queuePageState.previousQueue)) {
        window.queuePageState.queue = newQueue;
        $("#auto-refresh tbody").html(window.queuePage_generateHTML());
        window.queuePageState.previousQueue = newQueue;

        // Initialize Drag and Drop after HTML is rendered
        window.initSortable();
      }
    });
  };

  window.initSortable = function() {
    var el = document.getElementById('queue-body');
    // Only init if admin (drag handles exist) and not already initialized
    if ($(".drag-handle").length > 0 && el && !el.sortable) {
       Sortable.create(el, {
          handle: '.drag-handle', // Only drag using the handle icon
          animation: 150,
          filter: '.disabled-sort', // Cannot drag index 0
          onMove: function (evt) {
             // Prevent moving an item to index 0 (Currently Playing)
             return evt.related.className.indexOf('disabled-sort') === -1;
          },
          onEnd: function (evt) {
             if (evt.oldIndex === evt.newIndex) return;
             // Send new order to backend
             $.post("{{ url_for('queue.reorder') }}", {
                 old_index: evt.oldIndex,
                 new_index: evt.newIndex
             });
          }
      });
      el.sortable = true;
    }
  };

  window.queuePage_generateHTML = function() {
    var html = "";
    var queue = window.queuePageState.queue;
    var colSpan = isAdmin ? 4 : 2;

    if (queue.length > 0) {
      queue.forEach(function(e, index) {
        var isPlaying = (index === 0);
        var rowClass = isPlaying ? "disabled-sort has-background-dark" : "";

        html += '<tr class="' + rowClass + '" data-index="' + index + '">';
        html += '<td width="20px" style="padding: 12px 5px">' + (index + 1) + '</td>';

        if (isAdmin) {
          html += '<td width="40px" class="has-text-centered" style="padding: 5px 0px; vertical-align: middle;">';
          if (isPlaying) {
            html += '<i class="icon icon-play has-text-success is-size-5"></i>';
          } else {
            html += '<div class="drag-handle" style="cursor: grab; padding: 7px;" title="Drag to reorder"><i class="icon icon-th-list has-text-grey-light"></i></div>';
          }
          html += '</td>';
        }

        html += '<td style="padding-left: 10px; vertical-align: middle;">';
        html += '<div class="is-flex is-flex-direction-column">';
        html += '<span class="has-text-weight-bold ' + (isPlaying ? 'has-text-success' : '') + '">' + e.title + '</span>';
        html += '<span class="is-size-7 has-text-grey">' + e.user + '</span>';
        html += '</div></td>';

        if (isAdmin) {
          html += '<td width="50px" style="vertical-align: middle; text-align: right; padding-right: 10px;">';
          if (!isPlaying) {
            html += '<a class="button is-small is-text" data-index="' + index + '" data-file="' + escape(e.file) + '" data-title="' + escape(e.title) + '">';
            html += '<i class="icon icon-cog is-size-5"></i></a>';
          }
          html += '</td>';
        }

        html += '</tr>';
      });
    } else {
      // MSG: Placeholder text when queue is empty
      html += '<tr><td colspan="' + colSpan + '"><p class="has-text-warning p-3">{{ _("The queue is empty") }}</p></td></tr>';
    }
    return html;
  };

  // Open the modal menu
  window.openSongOptions = function(index, file, title) {
      $('#modal-song-title').text(title);

      // Update links with specific file
      var baseUrl = "/queue/edit?song=" + encodeURIComponent(file);
      $('#opt-up').attr('href', baseUrl + "&action=up");
      $('#opt-down').attr('href', baseUrl + "&action=down");
      $('#opt-top').attr('href', baseUrl + "&action=top");
      $('#opt-bottom').attr('href', baseUrl + "&action=bottom");
      $('#opt-delete').attr('href', baseUrl + "&action=delete");

      // Hide "Up" if at top (index 1), hide "Down" if at bottom
      var queueLen = window.queuePageState.queue.length;
      (index <= 1) ? $('#opt-up, #opt-top').hide() : $('#opt-up, #opt-top').show();
      (index >= queueLen - 1) ? $('#opt-down, #opt-bottom').hide() : $('#opt-down, #opt-bottom').show();

      $('#song-options-modal').addClass('is-active');
  }

  window.closeSongOptions = function() {
      $('#song-options-modal').removeClass('is-active');
  }

  // Socket listeners setup (same as before)
  window.socket.off("queue_update");
  window.socket.on("queue_update", window.queuePage_getQueue);
  window.queuePageState.previousQueue = null;

  // Initialize
  $(function() {
      window.queuePage_getQueue();
      // Close modal on background click
      $('.modal-background').click(window.closeSongOptions);

      // Use event delegation for menu buttons (handles dynamically generated content)
      $(document).on('click', '#queue-body a.button', function(e) {
          e.preventDefault();
          var $btn = $(this);
          var index = parseInt($btn.data('index'), 10);
          var file = decodeURIComponent($btn.data('file'));
          var title = decodeURIComponent($btn.data('title'));
          openSongOptions(index, file, title);
      });
  });

  // Visibility handler (same as before)
  // ... (Keep existing visibility logic here if needed) ...
</script>

{% endblock %}

{% block header %}
<h1 class>{% block title %}{% trans %}Queue{% endtrans %}{% endblock %}</h1>
{% endblock %}

{% block content %}

<div class="table-container">
    <table class="table is-fullwidth is-striped is-hoverable" id="auto-refresh" style="margin-bottom: 30px">
        <thead>
            <tr>
                <th width="20px">#</th>
                {% if admin %}<th width="40px"></th>{% endif %} <th>Song</th>
                {% if admin %}<th width="50px"></th>{% endif %} </tr>
        </thead>
        <tbody id="queue-body">
            </tbody>
    </table>
</div>

{% if admin %}
<div class="is-flex is-justify-content-space-between is-align-items-center mb-3">
	<div class="is-flex is-align-items-center">
		<a class="add-random has-text-success" href="#"
			><i class="icon icon-plus-circled is-size-5 mr-1"></i></a>
			{% trans %}Add <input id="randomNumberInput" class="input mx-2 p-2" pattern="\d*" maxlength="2" value="3" min="1" max="99" style="width: 42px" /> random songs{% endtrans %}
	</div>
	<div>
		<a class="button is-danger is-outlined confirm-clear" href="/queue/edit?action=clear">
		<i class="icon icon-trash-empty mr-1"></i>{% trans %}Clear all{% endtrans %}</a>
	</div>
</div>

<div class="modal" id="song-options-modal">
  <div class="modal-background"></div>
  <div class="modal-card" style="width: 90%; max-width: 400px;">
    <header class="modal-card-head" style="padding: 15px;">
      <p class="modal-card-title is-size-6" id="modal-song-title">Song Options</p>
      <button class="delete" aria-label="close" onclick="closeSongOptions()"></button>
    </header>
    <section class="modal-card-body" style="padding: 0;">
        <a id="opt-top" class="panel-block py-3">
            <span class="icon has-text-info mr-2"><i class="icon-up-big"></i></span>
            <b>{% trans %}Play Next{% endtrans %}</b>&nbsp;({% trans %}Move to Top{% endtrans %})
        </a>
        <a id="opt-up" class="panel-block py-3">
            <span class="icon mr-2"><i class="icon-up-circled"></i></span>
            {% trans %}Move Up{% endtrans %}
        </a>
        <a id="opt-down" class="panel-block py-3">
            <span class="icon mr-2"><i class="icon-down-circled"></i></span>
            {% trans %}Move Down{% endtrans %}
        </a>
        <a id="opt-bottom" class="panel-block py-3">
            <span class="icon has-text-info mr-2"><i class="icon-down-big"></i></span>
            {% trans %}Move to Bottom{% endtrans %}
        </a>
        <a id="opt-delete" class="panel-block py-3 has-text-danger">
            <span class="icon mr-2"><i class="icon-trash-empty"></i></span>
            {% trans %}Remove from Queue{% endtrans %}
        </a>
    </section>
  </div>
</div>
{% endif %}

<div id="downloads-section" style="display:none; margin-top: 30px; border-top: 1px solid #dbdbdb; padding-top: 20px;">
    <h3 class="title is-4">{{ _('Download queue') }}</h3>
    <div id="downloads-container"></div>
</div>

{% endblock %}