{% extends 'base.html' %} {% block scripts %}
<!-- <meta http-equiv="refresh" content="5" /> -->

<script>
  // Ensure global socket exists
  if (typeof window.socket === 'undefined') {
    window.socket = io();
  }

  // Initialize queue state if needed
  if (typeof window.queuePageState === 'undefined') {
    window.queuePageState = {
      queue: [],
      previousQueue: null
    };
  }

  // Define global queue functions (will be called by socket listeners)
  window.queuePage_getQueue = function() {
    // Only fetch queue data if we're on the queue page (element exists)
    // This prevents unnecessary AJAX calls when socket updates fire on other pages
    if ($('#auto-refresh').length === 0) {
      return;
    }

    $.get('{{ url_for("queue.get_queue") }}', function (data) {
      var newQueue = JSON.parse(data);
      if (!isEqual(newQueue, window.queuePageState.previousQueue)) {
        window.queuePageState.queue = newQueue;
        $("#auto-refresh").html(window.queuePage_generateHTML());
        window.queuePageState.previousQueue = newQueue;
      }
    });
  };

  window.queuePage_generateHTML = function() {
    var html = "";
    var queue = window.queuePageState.queue;
    if (queue.length > 0) {
      queue.forEach((e, index) => {
        html += `
          <tr value=${e.title}>
            <td width="20px" style="padding: 5px 0px">${index + 1}</td>
            {% if admin %}
              <td width="20px" style="padding: 5px 0px">
                <a
                  class="up-button"
                  href="/queue/edit?action=up&song=${encodeURIComponent(e.file)}"
                  title="Move up in queue"
                  ><i class="icon  icon-up-circled ${index == 0 && "is-hidden"}"></i>
                </a>
              </td>
              <td width="20px" style="padding: 5px 0px">
                <a
                  class="down-button"
                  href="/queue/edit?action=down&song=${encodeURIComponent(e.file)}"
                  title="Move down in queue"
                  ><i class="icon  icon-down-circled ${index + 1 == queue.length && "is-hidden"}"></i>
                </a>
              </td>
            {% endif %}
            <td style="padding-left: 10px"><b class="is-hidden-tablet has-text-success">${e.user}: </b> ${e.title}</td>
            <td style="padding-left: 5px" class="queue-user is-hidden-mobile has-text-success"><b>${e.user}</b></td>
            {% if admin %}
              <td width="20px">
                <a
                  class="delete-button confirm-delete has-text-danger"
                  title="${e.title}"
                  href="/queue/edit?action=delete&song=${encodeURIComponent(e.file)}"
                  ><i class="icon icon-trash-empty"></i>
                </a>
              </td>
            {% endif %}
          </tr>
        `;
      });
    }
    else {
      // {# MSG: Placeholder text which appears instead of a song when the queue is empty. #}
      html += `<tr><td><p class="has-text-warning">{{ _('The queue is empty') }}</p></td></tr>`;
    }
    return html;
  };

  // Queue management click handlers are now in spa-navigation.js
  // This prevents duplicate handlers during SPA navigation

  // Clean up old listeners and attach fresh one
  window.socket.off("queue_update");
  window.socket.on("queue_update", window.queuePage_getQueue);

  // Reset previousQueue so first load always updates the DOM
  // This is critical for SPA navigation where DOM is replaced but data may be the same
  window.queuePageState.previousQueue = null;

  // Initialize queue immediately - works for both initial load and SPA navigation
  if (document.readyState === 'loading') {
    // Initial page load - wait for DOM
    $(function() {
      window.queuePage_getQueue();
    });
  } else {
    // DOM already ready (SPA navigation) - execute immediately
    window.queuePage_getQueue();
  }

  // Handle visibility changes - remove old listener first to prevent duplicates
  document.removeEventListener("visibilitychange", window.queuePage_visibilityHandler);
  window.queuePage_visibilityHandler = function() {
    if (document.visibilityState === 'visible') {
      window.queuePage_getQueue();
      if (!window.socket.connected) {
        console.log('Reconnecting socket...');
        window.socket = io();
        window.socket.on("queue_update", window.queuePage_getQueue);
      }
    }
  };
  document.addEventListener("visibilitychange", window.queuePage_visibilityHandler);

  // Add random songs handler is now in spa-navigation.js

  // Download Progress Polling
  window.queuePage_getDownloads = function() {
      // Clean up existing timer if any
      if (window.downloadPollTimer) {
          clearTimeout(window.downloadPollTimer);
      }

      // Stop if we left the page
      if ($('#downloads-section').length === 0) {
          return;
      }

      $.get('{{ url_for("queue.get_current_downloads") }}', function(data) {
          var status = JSON.parse(data);
          var html = "";

          if (status.active) {
              var d = status.active;
              var progressClass = "is-info";
              if (d.status === 'complete') progressClass = "is-success";
              if (d.status === 'error') progressClass = "is-danger";

              html += `
                  <div class="box mb-4 has-background-dark">
                      <h4 class="title is-5 mb-2">${d.title}</h4>
                      <!-- inline style to ensure background visibility if theme overrides it -->
                      <progress class="progress ${progressClass}" value="${d.progress}" max="100" style="background-color: #dbdbdb;">${d.progress}%</progress>
                      <div class="level is-mobile is-size-7 mt-1">
                          <div class="level-left">
                              <span class="level-item text-muted"><b>Status:</b>&nbsp;${d.status}</span>
                          </div>
                          <div class="level-right">
                              <span class="level-item"><b>Speed:</b>&nbsp;${d.speed}&nbsp;&nbsp;&nbsp;<b>ETA:</b>&nbsp;${d.eta}</span>
                          </div>
                      </div>
                  </div>
              `;
          }

          if (status.pending && status.pending.length > 0) {
              html += `<div class="content"><h5 class="title is-6 mb-2">{{ _('Pending downloads') }}</h5>`;
              status.pending.forEach(function(d) {
                  html += `
                      <div class="box mb-2 p-3 has-background-dark is-flex is-align-items-center">
                          <span class="has-text-grey">${d.display_title || d.video_url}</span>
                          <span class="tag is-light is-rounded ml-auto">{{ _('Queued') }}</span>
                      </div>
                  `;
              });
              html += `</div>`;
          }

          if (status.errors && status.errors.length > 0) {
              html += `<div class="content"><h5 class="title is-6 mb-2 has-text-danger">{{ _('Download Errors') }}</h5>`;
              status.errors.forEach(function(d) {
                  html += `
                      <div class="box mb-2 p-3 has-background-white-ter is-flex is-align-items-center" style="border-left: 4px solid #f14668;">
                          <span class="icon has-text-danger mr-2"><i class="icon-cancel"></i></span>
                          <div class="is-flex-grow-1" style="min-width: 0;">
                              <p class="has-text-grey mb-0 is-truncated" title="${d.title || d.url}">${d.title || d.url}</p>
                              <p class="help is-danger mb-0 is-truncated" title="${d.error}">${d.error}</p>
                          </div>
                          <span class="tag is-danger is-light is-rounded ml-2">{{ _('Failed') }}</span>
                          <button class="delete ml-2" onclick="dismissDownloadError('${d.id}')" title="{{ _('Dismiss') }}"></button>
                      </div>
                  `;
              });
              html += `</div>`;
          }

          if (html) {
              $("#downloads-container").html(html);
              $("#downloads-section").fadeIn();
          } else {
              $("#downloads-section").fadeOut();
          }

          // Continue polling only if there are active items or pending downloads
          // Error items don't need constant polling
          var shouldPoll = status.active || (status.pending && status.pending.length > 0);

          if (shouldPoll && $('#downloads-section').length > 0) {
              window.downloadPollTimer = setTimeout(window.queuePage_getDownloads, 500);
          }
      });
  };

  window.dismissDownloadError = function(errorId) {
      $.ajax({
          url: '{{ url_for("queue.delete_download_error", error_id="ERROR_ID") }}'.replace("ERROR_ID", errorId),
          type: 'DELETE',
          success: function(result) {
              // Refresh immediately since polling might be stopped
              window.queuePage_getDownloads();
          }
      });
  };

  // Socket listeners for download activity
  window.socket.off("download_started");
  window.socket.on("download_started", function() {
      // Start polling if not already running
      if (!window.downloadPollTimer) {
          window.queuePage_getDownloads();
      }
  });

  window.socket.off("download_stopped");
  window.socket.on("download_stopped", function() {
       // Do one final fetch to show completion/errors then stop
       // The getDownloads function handles stopping if nothing is active
       if (window.downloadPollTimer) {
           clearTimeout(window.downloadPollTimer);
           window.downloadPollTimer = null;
       }
       window.queuePage_getDownloads();
  });

  // Start polling when page loads (or re-loads in SPA)
  // We hook into the same visibility/load events as the queue
  var originalVisibilityHandler = window.queuePage_visibilityHandler;
  window.queuePage_visibilityHandler = function() {
      originalVisibilityHandler();
      if (document.visibilityState === 'visible') {
         window.queuePage_getDownloads();
      }
  };

  // Initial kickoff - check if we need to poll
  $(function() {
      window.queuePage_getDownloads();
  });
</script>

{% endblock %}

{% block header %}
<h1 class>{% block title %}
  {# MSG: Title of the page showing the currently queued songs. #}
  {%- trans -%}Queue{%- endtrans -%}
  {% endblock %}</h1>
{% endblock %}

{% block content %}

<table class="table is-striped" id="auto-refresh" style="margin-bottom: 30px">
</table>

{% if admin %}
<div class="is-flex is-justify-content-space-between is-align-items-center mb-3">
	<div class="is-flex is-align-items-center">
		<a class="add-random has-text-success" href="#"
			{# MSG: Button text which picks a given number of random songs from the already downloaded songs and adds them to the queue. #}
			><i class="icon icon-plus-circled is-size-5 mr-1"></i></a>
			{% trans %}Add <input id="randomNumberInput" class="input mx-2 p-2" pattern="\d*" maxlength="2" value="3" min="1" max="99" style="width: 42px" /> random songs{% endtrans %}
	</div>

	<div>
		<a
		class="button is-danger is-outlined confirm-clear"
		href="/queue/edit?action=clear"
		{# MSG: Text for the button which clears the entire queue. #}
		><i class="icon icon-trash-empty mr-1"></i>{% trans %}Clear all{% endtrans %}</a>
	</div>
</div>


{% endif %}

<div id="downloads-section" style="display:none; margin-top: 30px; border-top: 1px solid #dbdbdb; padding-top: 20px;">
    <h3 class="title is-4">{{ _('Download queue') }}</h3>
    <div id="downloads-container"></div>
</div>

{% endblock %}
