{% extends 'base.html' %} {% block scripts %}
<link href="{{  url_for('static', filename='selectize.min.css') }}" rel="stylesheet" />
<script src="{{  url_for('static', filename='selectize-0.12.6.min.js') }}"></script>
<style>
	.optgroup-header {
		font-weight: bold;
	}

	.row {
		display: flex;
		border-bottom: 1px solid #cccccc;
	}

	.col-icon {
		padding-left: 1px;
	}

	.col-text {
		padding-left: 2px;
		font-size: 120%;
	}

	.selectize-input {
		height: 40px;
		border-top-right-radius: 0;
		border-bottom-right-radius: 0;
		font-size: 1rem;
	}

	/* --- Search result list ---------------------------------- */
	ul.search_result_items {
		list-style: none;
		padding: 0;
		margin: 0;
	}
	ul.search_result_items li {
		display: flex;
		flex-direction: column;
		align-items: stretch;
		gap: 0.75rem;
		padding: 0.75rem;
	}
	ul.search_result_items li:nth-child(odd) {
		background-color: rgb(50, 55, 55);
	}
	@media screen and (min-width: 768px) {
		ul.search_result_items li {
			flex-direction: row;
			align-items: center;
		}
	}

	/* Thumbnail: full width on mobile, fixed 200px on desktop */
	#search-results .img-wrapper {
		position: relative;
		cursor: pointer;
		width: 100%;
		flex-shrink: 0;
	}
	@media screen and (min-width: 768px) {
		#search-results .img-wrapper {
			width: 200px;
		}
	}
	#search-results .img-frame {
		position: relative;
		overflow: hidden;
		aspect-ratio: 16 / 9;
	}
	#search-results .img-wrapper img {
		display: block;
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: opacity 0.3s ease;
	}

	/* Meta: title fills space, button pinned right */
	.search_result_items_meta {
		display: flex;
		align-items: center;
		gap: 1rem;
		flex: 1;
		min-width: 0;
		text-align: left;
	}
	.search_result_items_meta > div:first-child {
		flex: 1;
		min-width: 0;
	}
	.search_result_items_download {
		flex-shrink: 0;
	}

	#search-results .img-wrapper:hover img {
		opacity: 0.7;
		box-shadow: 0px 0px 3px 1px #878787;
	}

	/* Semi-transparent circle behind the play icon */
	#search-results .img-wrapper::before {
		content: "";
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		width: 80px;
		height: 80px;
		background-color: rgba(0, 0, 0, 0.6);
		border-radius: 50%;
		opacity: 0.7;
		transition: opacity 0.3s ease;
		pointer-events: none;
		z-index: 1;
	}

	/* Fontello play icon overlay */
	#search-results .img-wrapper::after {
		font-family: "fontello";
		content: "\e800";
		position: absolute;
		top: 50%;
		left: 51%;
		transform: translate(-50%, -50%);
		font-size: 2rem;
		color: white;
		opacity: 0.9;
		transition: all 0.3s ease;
		text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
		pointer-events: none;
		z-index: 2;
	}

	/* Hover: full opacity and slight scale on desktop */
	#search-results .img-wrapper:hover::before {
		opacity: 1;
	}

	#search-results .img-wrapper:hover::after {
		opacity: 1;
		transform: translate(-50%, -50%) scale(1.2);
	}

	.video-container {
		aspect-ratio: 16 / 9;
	}
	.video-container video {
		width: 100%;
		height: 100%;
	}

	.duration-badge {
		position: absolute;
		bottom: 4px;
		right: 4px;
		background: rgba(0, 0, 0, 0.8);
		color: #fff;
		font-size: 0.75rem;
		padding: 2px 4px;
		border-radius: 3px;
		pointer-events: none;
		z-index: 3; /* above the play-icon overlays (z-index 1 and 2) */
	}

	/* Loading overlay for the video preview modal.
	   Bulma's is-loading only styles buttons/controls, not arbitrary divs,
	   so we define the spinner here for .modal-content. */
	.modal-content.is-loading {
		position: relative;
	}
	.modal-content.is-loading::before {
		content: "";
		position: absolute;
		inset: 0;
		background: rgba(0, 0, 0, 0.6);
		z-index: 10;
	}
	.modal-content.is-loading::after {
		content: "";
		position: absolute;
		top: 50%;
		left: 50%;
		width: 2.5rem;
		height: 2.5rem;
		margin-top: -1.25rem;
		margin-left: -1.25rem;
		border: 3px solid rgba(255, 255, 255, 0.3);
		border-top-color: #fff;
		border-radius: 50%;
		animation: spinAround 0.6s linear infinite;
		z-index: 11;
	}
	@keyframes spinAround {
		from { transform: rotate(0deg); }
		to { transform: rotate(360deg); }
	}
</style>
<script>
	$(function () {
		$("#search_result_selector").focus();

		$("#search-link").click(function () {
			if (!$("#search-link").is("[disabled=disabled]")) {
				$("#search-link").addClass("is-loading");
			}
		});

		$("#direct-download-button").click(function () {
			var url = $("#direct-download-url").val();
			if (!url) return;
			downloadSong(url, "", this);
		});

		$("#add-queue-link").click(function () {});

		//START SELECTIZE CHANGES

		//if enter key press, by default search button is click
		$(document).keypress(function (event) {
			if (event.which == "13") {
				event.preventDefault();

				if ($(".search-selectize .selectize-input input").val()) {
					$("#search-link").trigger("click");
				} else if ($(".search-selectize").find(":selected").text()) {
					$("#add-queue-link").trigger("click");
				}
			}
		});

		$("#add-queue-link").hide();
		$("#add-queue-link").attr("disabled", "true");
		$("#search-link").attr("disabled", "true");
		var $select = $("#song_to_add").selectize({
			valueField: "path",
			labelField: "fileName",
			searchField: ["fileName"],
			optgroupField: "type",
			optgroups: [
				{
					value: "autocomplete",
					label: '{{ _("Available songs in local library") }}',
				},
			],
			createOnBlur: true,
			openOnFocus: false,
			createFilter: function (input) {
				return input.length >= 2;
			},
			onInitialize: function () {
				var that = this;

				this.$control.on("click", function () {
					that.ignoreFocusOpen = true;
					setTimeout(function () {
						that.ignoreFocusOpen = false;
					}, 50);
				});
			},

			onFocus: function () {
				if ($(window).width() <= 500 && $(window).height() <= 740) {
					document.getElementById("search-field").scrollIntoView();
				}
				if (!this.ignoreFocusOpen) {
					this.open();
				}
			},
			onBlur: function () {
				this.setTextboxValue(this.currentResults.query);
			},
			onChange: function (id) {
				if (!id) {
					$("#add-queue-link").attr("disabled", "true");
					$("#search-link").attr("disabled", "true");
					$("#add-queue-link").hide();
					$("#search-link").show();
				} else {
					$("#add-queue-link").removeAttr("disabled");
					$("#search-link").removeAttr("disabled");
					$("#add-queue-link").show();
					$("#search-link").hide();
				}
			},
			onType: function (text) {
				if (!text) {
					console.log("no text");
					$("#search-link").attr("disabled", "true");
					// $("#add-queue-link").show();
					// $("#search-link").hide();
				} else {
					console.log("has text: " + text);
					$("#search-link").removeAttr("disabled");
					$("#add-queue-link").hide();
					$("#search-link").show();
				}
			},
			render: {
				option: function (item, escape) {
					return (
						'<div class="row">' +
						'<div class="col-icon"><i class="icon icon-music has-text-info"></i></div>' +
						'<div class="col-text">' +
						escape(item.fileName) +
						"</div>" +
						"</div>"
					);
				},
				optgroup_header: function (data, escape) {
					return '<div class="optgroup-header">' + escape(data.label) + "</div>";
				},
			},
			load: function (query, callback) {
				if (query.length < 2) return callback;
				$.ajax({
					url: "{{ url_for('search.autocomplete') }}" + "?q=" + query,
					type: "get",
					success: function (data) {
						callback(data);
					},
				});
			},
		});

		// re-populate the search field with previous search term
		const urlParams = new URLSearchParams(window.location.search);
		const qSearchString = urlParams.get("search_string");
		if (qSearchString) {
			$("#song_to_add-selectized").val(qSearchString);
			$("#song_to_add-selectized").width("100%");
		}

		$("#clear-search").on("click", function (e) {
			e.preventDefault();
			$select[0].selectize.clear();
			$("#song_to_add-selectized").val("");
		});

		$("#search-link").on("click", function (e) {
			e.preventDefault();
			var search_term = $(".search-selectize .selectize-input input").val();
			var include_non_karaoke = $("#include-non-karaoke").is(":checked");
			if (search_term) {
				$("#searching_loader").removeClass("is-hidden");
				$("#searching_loader #search_term").text(search_term);
				$("#search-link").attr("disabled", "true");
				$("#search_string").val(search_term);
				$("#non_karaoke").val(include_non_karaoke);
				$("#container_search_result").hide();
				$("#container_search_form form").submit();
			}
		});
		$("#add-queue-link").on("click", function (e) {
			e.preventDefault();
			if ($(".search-selectize").find(":selected").text()) {
				$("#add-queue-link").attr("disabled", "true");
				$("#add-queue-link").addClass("is-loading");
				setTimeout(function () {
					$("#add-queue-link").removeClass("is-loading");
				}, 1000);
				$.ajax({
					url: "{{ url_for('queue.enqueue') }}",
					type: "post",
					data: $("#queue-form").serialize(),
					success: function (data) {
						var obj = JSON.parse(data);
						if (obj.success[0]) {
							showNotification(obj.success[1], "is-success");
						} else {
							showNotification(obj.success[1], "is-danger");
						}
						$select[0].selectize.clear();
					},
				});
			}
		});

		//END SELECTIZE CHANGES

		$("#youtube-link").attr("href", $("#search_result_selector").val());
		$("#youtube-link").text($("#search_result_selector").val());

		//get youtube thumbnail based on ID
		i = -1;
		changeImage();

		$(document).on("change", "#search_result_selector", function () {
			var url = $("#search_result_selector").val();
			$("#youtube-link").attr("href", url);
			$("#youtube-link").text(url);
			changeImage();
		});
		//alow click of images
		$("#youtube-thumb").click(function (e) {
			changeImage();
		});
		setInterval(function () {
			$("#youtube-thumb").trigger("click");
		}, 2000);

		$("#advanced-settings").hide();

		// handle show advanced state
		$("#show-advanced").on("change", function () {
			if ($("#show-advanced").is(":checked")) {
				$("#advanced-settings").show();
			} else {
				$("#advanced-settings").hide();
			}
		});

		// handle direct download url input change
		$("#direct-download-url").on("input", function () {
			var v = $("#direct-download-url").val();
			if (isYoutubeURL(v)) {
				$("#direct-download-button").removeAttr("disabled");
			} else {
				$("#direct-download-button").attr("disabled", true);
			}
		});

		setUserCookie(); // Don't reload page after setting cookie

        // Restore the override name if the page just reloaded from a search
        var activeKjName = sessionStorage.getItem("active_kj_singer");
        if (activeKjName) {
            $("#kj_singer_override").val(activeKjName);
        }
        // Save the override name to short-term memory whenever you type
        $("#kj_singer_override").on("input", function() {
            var currentVal = $(this).val();
            sessionStorage.setItem("active_kj_singer", currentVal);
         
		// Populate the dropdown as the KJ types
        $("#kj_singer_override").on("input", function() {
            var currentVal = $(this).val().toLowerCase();
            var history = getKjHistory();
            var $dropdown = $("#singer_history_dropdown");
            var $list = $("#singer_history_list");

            $list.empty();
            
            // Hide if input is empty
            if (!currentVal) {
                $dropdown.hide();
                return;
            }

            // Find matching singers in the database
            var matches = Object.keys(history).filter(name => name.toLowerCase().includes(currentVal));

            if (matches.length > 0) {
                matches.forEach(name => {
                    var songs = history[name] || [];
                    var recentSongs = [...songs].reverse(); // Sort newest first
                    var displaySongs = recentSongs.slice(0, 5);
                    var extraCount = recentSongs.length - 5;

                    var $li = $("<li>").addClass("p-2").css({"border-bottom": "1px solid #333"});

                    // 1. Clickable Singer Name Header
                    var $nameDiv = $("<div>")
                        .css({"cursor": "pointer", "font-weight": "bold", "color": "#ffdd57", "padding-bottom": "4px"})
                        .text(name);

                    $nameDiv.on("click", function() {
                        $("#kj_singer_override").val(name);
                        sessionStorage.setItem("active_kj_singer", name);
                        $(".song_added_by").val(name);
                        $dropdown.hide();
                    });
                    $li.append($nameDiv);

                    // Helper function for True-Backend Smart Auto-Queue
                    function attachSongClick($el, song) {
                        $el.on("click", function(e) {
                            e.stopPropagation(); // Prevent triggering parent elements
                            
                            // Lock in the singer
                            $("#kj_singer_override").val(name);
                            sessionStorage.setItem("active_kj_singer", name);
                            $(".song_added_by").val(name);
                            $dropdown.hide();

                            if (confirm("Instantly queue '" + song.title + "' for " + name + "?")) {
                                $("#kj_singer_override").css("background-color", "#fff3cd");

                                // Sub-function to handle the enqueue API call cleanly
                                function submitToQueue(pathToQueue) {
                                    $.ajax({
                                        type: "POST",
                                        url: "{{ url_for('queue.enqueue') }}", 
                                        data: {
                                            song_to_add: pathToQueue,
                                            song_added_by: name
                                        },
                                        success: function(response) {
                                            try {
                                                var obj = typeof response === "string" ? JSON.parse(response) : response;
                                                if (obj.success && obj.success[0] === false) {
                                                    alert("Queue error: " + obj.success[1]);
                                                    return;
                                                }
                                            } catch(err) {}
                                            triggerSuccessRefresh();
                                        },
                                        error: function() {
                                            alert("Queue endpoint rejected the request. Please add manually.");
                                        }
                                    });
                                }

                                // 1. Check if the saved track is ALREADY a local path (not a YouTube link)
                                if (!isYoutubeURL(song.url)) {
                                    submitToQueue(song.url);
                                } else {
                                    // 2. It's a YouTube link. Ask Python if we downloaded it recently.
                                    $.ajax({
                                        url: "{{ url_for('search.autocomplete') }}" + "?q=" + encodeURIComponent(song.title),
                                        type: "GET",
                                        success: function(localMatches) {
                                            if (localMatches && localMatches.length > 0) {
                                                // LOCAL CACHE HIT
                                                submitToQueue(localMatches[0].path);
                                            } else {
                                                // NO LOCAL MATCH: Send to download queue
                                                $.ajax({
                                                    type: "POST",
                                                    url: "{{ url_for('search.download') }}",
                                                    contentType: "application/json",
                                                    data: JSON.stringify({
                                                        song_url: song.url,
                                                        song_title: song.title,
                                                        song_added_by: name,
                                                        queue: true
                                                    }),
                                                    success: triggerSuccessRefresh
                                                });
                                            }
                                        },
                                        error: function() {
                                            alert("Failed to communicate with the local library.");
                                        }
                                    });
                                }
                            }
                        });
                    }

                    // Reusable visual flash and refresh
                    function triggerSuccessRefresh() {
                        $("#kj_singer_override").css("background-color", "#d4edda");
                        setTimeout(function() {
                            window.location.reload();
                        }, 600);
                    }

                    // 2. Build the hierarchical song list
                    if (displaySongs.length > 0) {
                        var $songUl = $("<ul>").css({"list-style-type": "circle", "margin-left": "20px", "font-size": "0.85rem", "color": "#b5b5b5"});

                        displaySongs.forEach(function(song) {
                            var $songLi = $("<li>").css({"cursor": "pointer", "padding": "2px 0"}).text(song.title);
                            attachSongClick($songLi, song);
                            $songUl.append($songLi);
                        });

                        // 3. Accordion expansion for > 5 tracks
                        if (extraCount > 0) {
                            var $moreLi = $("<li>")
                                .css({"cursor": "pointer", "color": "#3273dc", "font-style": "italic", "padding-top": "4px", "list-style-type": "none", "margin-left": "-20px"})
                                .text("+ " + extraCount + " older tracks (click to expand)");

                            var $hiddenUl = $("<ul>").css({"display": "none", "list-style-type": "circle", "margin-left": "0", "margin-top": "4px"});

                            recentSongs.slice(5).forEach(function(song) {
                                var $hiddenSongLi = $("<li>").css({"cursor": "pointer", "padding": "2px 0", "color": "#666"}).text(song.title);
                                attachSongClick($hiddenSongLi, song);
                                $hiddenUl.append($hiddenSongLi);
                            });

                            $moreLi.on("click", function(e) {
                                e.stopPropagation();
                                $(this).hide();
                                $hiddenUl.slideDown("fast");
                            });

                            $songUl.append($moreLi).append($hiddenUl);
                        }
                        $li.append($songUl);
                    } else {
                        $li.append($("<div>").addClass("is-size-7 has-text-grey ml-4").text("No track history"));
                    }
                    
                    $list.append($li);
                });
                $dropdown.show();
            } else {
                $dropdown.hide();
            }
        });

        // Hide the dropdown if the user clicks anywhere else on the page
        $(document).on("click", function(e) {
            if (!$(e.target).closest("#kj_override_container").length) {
                $("#singer_history_dropdown").hide();
            }
        });	
            
            // Update any hidden standard PiKaraoke fields just in case
            var overrideName = (currentVal || "").trim();
            $(".song_added_by").val(overrideName || getUserCookie());
        });
// Show KJ block only if admin session cookie exists
        if (Cookies.get("admin") === "true" || document.cookie.includes("admin")) {
            $("#kj_override_container").show();
        } else {
            // Fallback: Check if they are on localhost, which implies the KJ machine
            if (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1") {
                $("#kj_override_container").show();
            }
        }

        // Initialize LocalStorage Database
        function getKjHistory() {
            var history = localStorage.getItem("kj_singer_history");
            return history ? JSON.parse(history) : {};
        }

        function saveToKjHistory(singerName, songTitle, songUrl) {
            if (!singerName || !songTitle) return;
            var history = getKjHistory();
            if (!history[singerName]) {
                history[singerName] = [];
            }
            // Prevent duplicates
            var exists = history[singerName].some(song => song.url === songUrl);
            if (!exists) {
                history[singerName].push({ title: songTitle, url: songUrl });
                localStorage.setItem("kj_singer_history", JSON.stringify(history));
            }
        }
		// Restore checkbox states from cookies
		restoreCheckboxStates();

		// Save checkbox states when they change
		$("#include-non-karaoke").change(function () {
			Cookies.set("include-non-karaoke", $(this).is(":checked"), {
				expires: 365,
			});
		});

		$("#add-to-queue-direct, #add-to-queue-search").change(function () {
			Cookies.set("add-to-queue-on-download", $(this).is(":checked"), {
				expires: 365,
			});
			// Sync both checkboxes to have the same state
			var isChecked = $(this).is(":checked");
			$("#add-to-queue-direct, #add-to-queue-search").prop("checked", isChecked);
		});

		function downloadSong(songUrl, songTitle, button) {
			var $btn = $(button);
			var originalText = $btn.html();
			$btn.css("min-width", $btn.outerWidth() + "px");
			$btn.addClass("is-loading").attr("disabled", true);
			var overrideName = ($("#kj_singer_override").val() || "").trim();
            if (overrideName && songTitle) {
                saveToKjHistory(overrideName, songTitle, songUrl);
            }
			// Strict priority: 1. KJ Override -> 2. Standard Input -> 3. Cookie -> 4. Fallback
            var overrideInput = $("#kj_singer_override").val();
            var overrideName = overrideInput ? overrideInput.trim() : null;
            var standardInput = $("#song_added_by").val(); // PiKaraoke's default input
            var finalSingerName = overrideName || standardInput || getUserCookie() || "KJ";

            // Save to local history if override is utilized
            if (overrideName && songTitle) {
                saveToKjHistory(overrideName, songTitle, songUrl);
            }
			$.ajax({
				url: "{{ url_for('search.download') }}",
				type: "POST",
				contentType: "application/json",
				data: JSON.stringify({
                  song_url: songUrl,
                  song_title: songTitle,
                  song_added_by: finalSingerName,
                  queue: true 
            }),
				success: function () {
					$btn.removeClass("is-loading").addClass("is-success")
						.html('<i class="icon icon-ok"></i>');
					setTimeout(function () {
						$btn.removeClass("is-success").html(originalText)
							.removeAttr("disabled").css("min-width", "");
					}, 3000);
				},
				error: function () {
					$btn.removeClass("is-loading").addClass("is-danger")
						.text("!");
					setTimeout(function () {
						$btn.removeClass("is-danger").html(originalText)
							.removeAttr("disabled").css("min-width", "");
					}, 3000);
				},
			});
		}

		const items = document.querySelectorAll(".search_result_items li");
		items.forEach((item) =>
			item.querySelector("button").addEventListener("click", function () {
				const url = item.getAttribute("value");
				const title = item.getAttribute("data-ytTitle");
				downloadSong(url, title, this);
			})
		);



		$("#search-results").on("click", ".img-wrapper", function () {
			const modal = document.getElementById("modal-js-example");
			const modalVideo = document.getElementById("modal-video");
			const modalContent = modal.querySelector(".modal-content");
			const videoUrl = $(this).data("url");

			modal.classList.add("is-active");
			modalContent.classList.add("is-loading");

			// Unlock autoplay on iOS/mobile: briefly play the empty video element
			// synchronously inside the click handler so Safari associates it with
			// a user gesture. Without this, the async AJAX callback's .play() is blocked.
			modalVideo.play().then(function () { modalVideo.pause(); }).catch(function () {});

			const closeButton = modal.querySelector(".modal-close");
			closeButton.focus();

			// Remove the spinner when the video starts playing or errors — not when
			// the AJAX returns, since the video still has to buffer after src is set.
			const stopLoading = function () {
				modalContent.classList.remove("is-loading");
			};
			modalVideo.addEventListener("playing", stopLoading, { once: true });
			modalVideo.addEventListener("error", stopLoading, { once: true });

			const closeModal = function () {
				modal.classList.remove("is-active");
				modalContent.classList.remove("is-loading");
				modalVideo.pause();
				modalVideo.src = "";
			};

			closeButton.onclick = closeModal;
			modal.querySelector(".modal-background").onclick = closeModal;

			$.ajax({
				url: "{{ url_for('search.preview') }}" + "?url=" + encodeURIComponent(videoUrl),
				type: "get",
				success: function (data) {
					if (modal.classList.contains("is-active")) {
						modalVideo.src = data.stream_url;
						modalVideo.load();
						modalVideo.play().catch(function () {});
					}
				},
				error: function () {
					closeModal();
				},
			});
		});
	});

	function isYoutubeURL(s) {
		if (s.includes("http")) {
			return s.includes("youtube.com/watch?v=") || s.includes("youtube.com/v/") || s.includes("youtu.be/");
		} else {
			return false;
		}
	}

	function changeImage() {
		var next = ++i % 4;
		var youtube_id = $("#search_result_selector").find(":selected").data("ytid");
		var fn = next == 0 ? "default" : next;
		var img_src = "https://img.youtube.com/vi/" + youtube_id + "/mq" + fn + ".jpg";
		$("#youtube-thumb").attr("src", img_src);
	}

	function restoreCheckboxStates() {
		// Restore "Include non-karaoke matches" checkbox state
		var includeNonKaraoke = Cookies.get("include-non-karaoke");
		if (includeNonKaraoke !== undefined) {
			$("#include-non-karaoke").prop("checked", includeNonKaraoke === "true");
		}

		// Restore "Add to queue once downloaded" checkbox state
		var addToQueue = Cookies.get("add-to-queue-on-download");
		if (addToQueue !== undefined) {
			var shouldCheck = addToQueue === "true";
			$("#add-to-queue-direct, #add-to-queue-search").prop("checked", shouldCheck);
		}
	}
	    // --- KJ Memory Export/Import ---
        
        // Export Memory to JSON
        $("#btn_export_history").on("click", function(e) {
            e.preventDefault(); // Stop any default navigation
            
            var data = localStorage.getItem("kj_singer_history") || "{}";
            var blob = new Blob([data], {type: "application/json"});
            var url = window.URL.createObjectURL(blob);
            
            var a = document.createElement("a");
            a.style.display = "none";
            a.href = url;
            
            // Format date for filename
            var d = new Date();
            var dateString = d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate();
            a.download = "kj_history_" + dateString + ".json"; 
            
            // Crucial Fix: Prevent PiKaraoke's SPA router from hijacking the download click
            a.addEventListener("click", function(event) {
                event.stopPropagation();
            });
            
            document.body.appendChild(a);
            a.click();
            
            // Cleanup memory
            setTimeout(function() {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        });

        // Trigger hidden file input
        $("#btn_import_history").on("click", function(e) {
            e.preventDefault();
            $("#file_import_history").click();
        });

        // Read and import the JSON file
        $("#file_import_history").on("change", function(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            var reader = new FileReader();
            reader.onload = function(event) {
                try {
                    // Verify it is actually valid JSON before wiping the current database
                    var json = JSON.parse(event.target.result);
                    localStorage.setItem("kj_singer_history", JSON.stringify(json));
                    
                    alert("KJ history successfully imported.");
                    $("#file_import_history").val(''); 
                    
                    // Reload to immediately apply the imported history to the UI
                    window.location.reload(); 
                } catch (err) {
                    alert("Error: Invalid JSON file.");
                    $("#file_import_history").val(''); 
                }
            };
            reader.readAsText(file);
        });

        // Trigger hidden file input
        $("#btn_import_history").on("click", function() {
            $("#file_import_history").click();
        });

        // Read and import the JSON file
        $("#file_import_history").on("change", function(e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(event) {
                try {
                    var json = JSON.parse(event.target.result);
                    localStorage.setItem("kj_singer_history", JSON.stringify(json));
                    alert("KJ history successfully imported.");
                    // Clear the file input so the same file can be selected again if needed
                    $("#file_import_history").val(''); 
                } catch (err) {
                    alert("Error: Invalid JSON file.");
                }
            };
            reader.readAsText(file);
        });
</script>
{% endblock %} {% block header %} {# MSG: Title for the search page. #}
<h1>{% block title %}{% trans %}Search / Add New{% endtrans %}{% endblock %}</h1>
{% endblock %} {% block content %}
<div id="kj_override_container" class="field mb-3" style="position: relative; display: none;">
                <div class="is-flex is-justify-content-space-between is-align-items-flex-end">
                    <label class="label is-small has-text-warning">KJ Override: Singer Name</label>
                    <div>
                        <a id="btn_export_history" class="is-size-7 has-text-info mr-2" style="cursor:pointer;">[Export]</a>
                        <a id="btn_import_history" class="is-size-7 has-text-info" style="cursor:pointer;">[Import]</a>
                    </div>
                </div>
                <div class="control has-icons-left">
                    <input class="input is-medium" type="text" id="kj_singer_override" placeholder="Enter singer to view history or queue..." autocomplete="off">
                    <span class="icon is-left">
                        <i class="icon icon-mic-1"></i>
                    </span>
                </div>
                <div id="singer_history_dropdown" class="box has-background-black-ter" style="display:none; position:absolute; z-index:100; width:100%; max-height: 250px; overflow-y:auto; padding:0; border: 1px solid #4a4a4a; margin-top: 2px;">
                    <ul id="singer_history_list" class="search_result_items" style="list-style: none; margin: 0; padding: 0;"></ul>
                </div>
                <input type="file" id="file_import_history" accept=".json" style="display:none;">
            </div>
<div>
	<div class="field" id="container_queue_form">
		<form id="queue-form">
			<div id="search-field" class="field has-addons mb-1">
				<div class="control is-expanded">
					<select id="song_to_add" class="search-selectize is-size-7" name="song_to_add">
						{# TODO MSG: Label #}
						<optgroup label="{{ _('Available Songs') }}" id="available-songs"></optgroup>
					</select>
				</div>
				<div class="control">
					{# MSG: Submit button on the search form for searching YouTube. #}
					<a class="button is-warning" id="search-link">{% trans %}Search{% endtrans %}</a>
					{# MSG: Submit button on the search form when selecting a locally downloaded song. The button adds it to
					the queue. #}
					<a class="button is-info" id="add-queue-link">{% trans %}Add to queue{% endtrans %}</a>
				</div>
				<input class="song_added_by" type="hidden" name="song_added_by" />
			</div>
			<div class="control is-flex is-justify-content-flex-end is-align-items-center mb-2">
				<a id="clear-search" class="has-text-danger" style="margin-right: 15px">
					{# MSG: Link which clears the text from the search box. #} {% trans %}Clear{% endtrans %}</a
				>
				<label class="checkbox is-flex is-align-items-center">
					<input type="checkbox" id="show-advanced" class="checkbox" name="show-advanced" />
					{# MSG: Checkbox label which enables more options when searching. #} {% trans %}Advanced{% endtrans %}
				</label>
			</div>

			<article class="message">
				<div class="message-body">
					<div class="columns is-vcentered is-mobile">
						<div class="column is-narrow">
							<span class="icon has-text-warning">
								{# MSG: Info icon at the start of the help text below the search bar. #}
								<i class="icon icon-info-circled-1 is-size-4" title="Info"></i>
							</span>
						</div>
						<div class="column has-text-warning-light">
							<p class="mb-1 is-italic">
								{# MSG: Help text below the search bar. #} {% trans -%}- Type a song (title/artist) to search
								the available songs and click 'Add to queue' to add it to the queue. {%- endtrans %}
							</p>
							<p class="is-italic">
								{# MSG: Additonal help text below the search bar. #} {% trans -%}- If the song doesn't appear in
								the "Available Songs" dropdown, click 'Search' to find it on Youtube {%- endtrans %}
							</p>
						</div>
					</div>
				</div>
			</article>
		</form>
	</div>

	<div>
		<div id="advanced-settings" class="box has-background-black-bis" style="margin-top: 10px; display: none">
			<div class="control">
				<label class="checkbox is-flex is-align-items-center">
					<input type="checkbox" class="checkbox" id="include-non-karaoke" name="include-non-karaoke" />
					{# MSG: Checkbox label which enables matching songs which are not karaoke versions (i.e. the songs still
					have a singer and are not just instrumentals.) #} {% trans %}Include non-karaoke matches{% endtrans %}
				</label>
			</div>
			<hr />
			<div class="control">
				<div class="label">
					{# MSG: Label for an input which takes a YouTube url directly instead of searching titles. #} {% trans
					%}Direct download YouTube url:{% endtrans %}
				</div>
				<div>
					<input
						class="input"
						id="direct-download-url"
						type="text"
						value="https://www.youtube.com/watch?v="
					/>
					<div class="field" style="margin-top: 5px">
						<label class="checkbox is-flex is-align-items-center">
							<input type="checkbox" class="checkbox" checked id="add-to-queue-direct" />
							{# MSG: Checkbox label which marks the song to be added to the queue after it finishes downloading.
							#} {% trans %}Add to queue once downloaded{% endtrans %}
						</label>
					</div>
					<div class="has-text-right" style="margin-top: 5px">
						<button class="button is-rounded is-primary" disabled id="direct-download-button">
							{# MSG: Button label for the direct download form's submit button. #} {% trans %}Download{%
							endtrans %}
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<hr />

	<div class="field is-hidden" id="container_search_form">
		<form action="{{ url_for('search.search') }}" method="get">
			<input id="search_string" type="text" name="search_string" />
			<input type="text" id="non_karaoke" name="non_karaoke" />
		</form>
	</div>

	<div id="searching_loader" class="control is-loading is-hidden">
		{% set placeholder_search_term %}
		<span id="search_term"></span>
		{% endset %} {# MSG: Html text which displays what was searched for, in quotes while the page is loading. #} {%
		trans search_term=placeholder_search_term -%} Searching YouTube for
		<small><i>'{{ search_term }}'</i></small>
		{%- endtrans %}
	</div>
	{% if search_results %}
	<div class="field" id="container_search_result">
		<label class="label">
			{# MSG: Html text which displays what was searched for, in quotes. #} {% trans search_term=search_string -%}
			Search results for
			<small><i>'{{search_string}}'</i></small>
			{%- endtrans %}
		</label>
		<div class="field">
			<label class="checkbox is-flex is-align-items-center">
				<input type="checkbox" checked id="add-to-queue-search" class="checkbox" />
				{# MSG: Checkbox label which marks the song to be added to the queue after it finishes downloading. #} {%
				trans %}Add to queue once downloaded{% endtrans %}
			</label>
		</div>
		<ul id="search-results" class="search_result_items">
			{% for title,url,id,channel,duration in search_results %}
			<li data-ytID="{{id}}" data-ytTitle="{{title}}" value="{{url}}" data-index="{{loop.index0}}">
				<div class="img-wrapper" data-url="{{url}}">
					<div class="img-frame">
						<img src="https://img.youtube.com/vi/{{id}}/mqdefault.jpg" />
						{% if duration %}<span class="duration-badge">{{ duration }}</span>{% endif %}
					</div>
				</div>
				<div class="search_result_items_meta">
					<div>
						{{title}}
						{% if channel %}<div class="is-size-7 has-text-grey">{{ channel }}</div>{% endif %}
						<a href="{{url}}" target="_blank" rel="noopener noreferrer" class="is-size-7 has-text-info">YouTube ↗</a>
					</div>
					<button class="button search_result_items_download">Download</button>
				</div>
			</li>
			{% endfor %}
		</ul>
		<div id="modal-js-example" class="modal">
			<div class="modal-background"></div>
			<div class="modal-content">
				<div class="video-container">
					<video id="modal-video" controls></video>
				</div>
			</div>
			<button class="modal-close is-large" aria-label="close"></button>
		</div>
	</div>
</div>
{% else %} {% endif %} {% endblock %}
